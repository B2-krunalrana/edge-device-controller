<!DOCTYPE html>
<html>
<head>
    <title>Device Connector</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f4f6f9;
            color: #1f2937;
        }

        .container {
            max-width: 500px;
            margin: auto;
            padding: 30px 20px;
            text-align: center;
        }

        h1 {
            margin-bottom: 5px;
            font-weight: 600;
        }

        p {
            color: #6b7280;
            margin-bottom: 20px;
        }

        #reader {
            width: 300px;
            margin: 20px auto;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #e5e7eb;
        }

        .status {
            margin-top: 10px;
            font-weight: 600;
        }

        .connected {
            color: #16a34a;
        }

        .error {
            color: #dc2626;
        }

        .button-group {
            margin-top: 20px;
        }

        button {
            padding: 12px 18px;
            margin: 8px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
            font-weight: 500;
            transition: 0.2s ease;
        }

        .primary {
            background: #2563eb;
            color: white;
        }

        .primary:hover {
            background: #1d4ed8;
        }

        .danger {
            background: #ef4444;
            color: white;
        }

        .danger:hover {
            background: #dc2626;
        }

        .log-box {
            background: white;
            margin-top: 25px;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            height: 220px;
            overflow-y: auto;
            text-align: left;
            font-size: 14px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .log-entry {
            margin-bottom: 6px;
        }

        .log-success {
            color: #16a34a;
        }

        .log-error {
            color: #dc2626;
        }

    </style>
</head>

<body>

<div class="container">

    <h1>Connect Local Device</h1>
    <p>Scan the QR code shown on your laptop</p>

    <div id="reader"></div>

    <div class="status" id="status">Not Connected</div>

    <div class="button-group">
        <button class="primary" onclick="runCommand()">Run Command</button>
        <button class="danger" onclick="disconnect()">Disconnect</button>
    </div>

    <div class="log-box" id="logs"></div>

</div>

<script>
let socket = null;
let html5QrCode = new Html5Qrcode("reader");

function log(message, type="") {
    const logs = document.getElementById("logs");
    const entry = document.createElement("div");
    entry.classList.add("log-entry");

    if (type === "success") entry.classList.add("log-success");
    if (type === "error") entry.classList.add("log-error");

    entry.textContent = message;
    logs.appendChild(entry);
    logs.scrollTop = logs.scrollHeight;
}

function setStatus(text, state="") {
    const status = document.getElementById("status");
    status.textContent = text;
    status.className = "status";

    if (state === "connected") status.classList.add("connected");
    if (state === "error") status.classList.add("error");
}

function onScanSuccess(decodedText) {
    html5QrCode.stop();
    log("Connecting to: " + decodedText);

    socket = new WebSocket(decodedText);

    socket.onopen = function() {
        setStatus("Connected", "connected");
        log("WebSocket connected", "success");
    };

    socket.onmessage = function(event) {
        log("Server: " + event.data);
    };

    socket.onerror = function() {
        setStatus("Connection Error", "error");
        log("Connection error", "error");
    };

    socket.onclose = function() {
        setStatus("Disconnected", "error");
        log("Connection closed", "error");
    };
}

// Prefer back camera
Html5Qrcode.getCameras().then(devices => {
    if (devices.length) {
        let backCamera = devices.find(device =>
            device.label.toLowerCase().includes("back")
        );

        const cameraId = backCamera ? backCamera.id : devices[0].id;

        html5QrCode.start(
            cameraId,
            { fps: 10, qrbox: 250 },
            onScanSuccess
        );
    } else {
        log("No camera found", "error");
    }
}).catch(err => {
    log("Camera permission denied", "error");
});

function runCommand() {
    if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send("run_command");
        log("Command sent");
    } else {
        log("Not connected", "error");
    }
}

function disconnect() {
    if (socket) {
        socket.close();
    }
}
</script>

</body>
</html>